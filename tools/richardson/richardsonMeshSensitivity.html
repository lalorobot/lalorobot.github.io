<!DOCTYPE html>
<html lang="en">
<style>
body {
	background-color: ivory;
}
</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesh Sensitivity Analysis</title>
    <script>
        // Convergence function
		function convergence(r21, e32, e21, r32, s, p) {
			return (1 / Math.log(r21)) * Math.abs(Math.log(Math.abs(e32 / e21)) + Math.log((Math.pow(r21, p) - s) / (Math.pow(r32, p) - s))) - p;
		}

		// Main function to perform calculations
		function runAnalysis() {
			// Get user inputs for N, phi, and t_vol
			let N = [parseFloat(document.getElementById("N1").value), parseFloat(document.getElementById("N2").value), parseFloat(document.getElementById("N3").value)];
			let phi = [parseFloat(document.getElementById("phi1").value), parseFloat(document.getElementById("phi2").value), parseFloat(document.getElementById("phi3").value)];
			let t_vol = parseFloat(document.getElementById("t_vol").value);
			let p = 0;

			// Calculate mesh representative cell lengths
			let h = N.map(n => 1/n * Math.pow(t_vol, 1 / 3));

			// Calculate refinement ratios and errors
			let r21 = h[1] / h[0];
			let r32 = h[2] / h[1];
			let e21 = phi[1] - phi[0];
			let e32 = phi[2] - phi[1];
			let checkSign = e32/e21;
			if (checkSign < 0) {
				s = -1;
			}
			else if (checkSign > 0) {
				s = 1;
			}
			else {
				s = 0;
			}
			
			let p_left = document.getElementById("p_left").value;
			let p_right = document.getElementById("p_right").value;
			let tol = document.getElementById("tol").value;
			let f_mid = 1
			while (Math.abs(f_mid) >= tol) {
				f_left = convergence(r21, e32, e21, r32, s, p_left);
				f_right = convergence(r21, e32, e21, r32, s, p_right);
				p_mid = (p_left + p_right)/2.0;
				f_mid = convergence(r21, e32, e21, r32, s, p_mid);
				if (f_left*f_mid < 0) {
					p_right = p_mid
				}
				else {
					p_left = p_mid
				}
			}
			
			let phi0 = phi[0] + (phi[0] - phi[1])/(Math.pow(r21, p_mid) - 1);
			let e = Math.abs((phi[0]-phi0)/phi0) * 100;
			
			// Display the result	
			document.getElementById("output").innerHTML = `
                <p>Representative cell lengths: [${h[0].toExponential(5)}, ${h[1].toExponential(5)}, ${h[2].toExponential(5)}] <p>
				<p>Extrapolated value for infinitely fine mesh: ${phi0.toFixed(4)}</p>
				<p>Extrapolative relative error (%): ${e.toFixed(4)}</p>
			`;
		}
    </script>
</head>
<body>
    <div style="text-align: center;">
    <h1>Mesh Sensitivity Analysis via Richardson Extrapolation</h1>
    <p>NOTE: This tool has been made with purely academic purposes in mind, it should NOT be trusted in real world use cases.</p>
    </div>
    <h2>Mesh cell counts</h2>
    <div>
        <label for="N1">Fine:</label>
        <input type="text" id="N1" value="988986">
    </div>
    <div>
        <label for="N2">Medium:</label>
        <input type="text" id="N2" value="724378">
    </div>
    <div>
        <label for="N3">Coarse:</label>
        <input type="text" id="N3" value="610333">
    </div>
    <h2>Test variable results</h2>
    <div>
        <label for="phi1">Fine:</label>
        <input type="text" id="phi1" value="1107.2248">
    </div>
    <div>
        <label for="phi2">Medium:</label>
        <input type="text" id="phi2" value="1102.0615">
    </div>
    <div>
        <label for="phi3">Coarse:</label>
        <input type="text" id="phi3" value="1103.1918">
    </div>
    <h2>Total mesh volume</h2>
    <div>
        <label for="t_vol">t_vol (Total volume):</label>
        <input type="text" id="t_vol" value="0.0008571677">
    </div>
    <h2>Bisecion method controls</h2>
    <div>
        <label for="p_left">Left bound:</label>
        <input type="text" id="p_left" value="0.1">
    </div>
    <div>
        <label for="p_right">Right bound:</label>
        <input type="text" id="p_right" value="20">
    </div>
    <div>
        <label for="tol">Tolerance:</label>
        <input type="text" id="tol" value="0.000001">
    </div>
    <button onclick="runAnalysis()">Run Analysis</button>
    <h2>Results</h2>
    <p id="result"></p>
    <div id="output"></div>
</body>
</html>
